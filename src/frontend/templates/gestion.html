<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPSEMIA - Configuration</title>
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-brand">
                    <img src="/static/assets/logo-slogan.png" alt="OPSEMIA - Acc√©l√©rez la v√©rit√© au service de la justice" class="header-logo-full">
                </div>
                <nav class="header-nav">
                    <a href="/" class="nav-link">üîç Recherche</a>
                    <a href="/conversations" class="nav-link">üí¨ Conversations</a>
                    <a href="/galerie" class="nav-link">üñºÔ∏è Galerie</a>
                    <a href="/gestion" class="nav-link active">‚öôÔ∏è Configuration</a>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Alertes -->
            <div id="alerts-container"></div>

            <!-- Section: Chargement de donn√©es (Messages) -->
            <div class="card">
                <div class="card-header">
                    üí¨ Chargement de messages
                </div>
                <form id="load-csv-form">
                    <div class="form-group">
                        <label class="form-label">
                            Fichier CSV de messages
                            <span class="help-icon" data-tooltip="Chemin vers le fichier CSV de messages (ex: Cas/Cas1/sms.csv). Peut √™tre un chemin relatif ou absolu.">?</span>
                        </label>
                        <input 
                            type="text" 
                            id="csv-path" 
                            class="form-input"
                            placeholder="Cas/Cas1/sms.csv"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="csv-reset">
                            <span>R√©initialiser la collection existante</span>
                            <span class="help-icon" data-tooltip="‚ö†Ô∏è Supprime toutes les donn√©es existantes avant le chargement">?</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        üì§ Charger et indexer les messages
                    </button>
                </form>
            </div>

            <!-- Section: Chargement d'images -->
            <div class="card">
                <div class="card-header">
                    üñºÔ∏è Chargement d'images
                </div>
                <form id="load-images-form">
                    <div class="form-group">
                        <label class="form-label">
                            Fichier CSV d'images
                            <span class="help-icon" data-tooltip="Chemin vers le fichier CSV d'images (ex: Cas/Cas4/images.csv). Doit contenir: nom_image, chemin, date_prise, heure_prise, latitude, longitude.">?</span>
                        </label>
                        <input 
                            type="text" 
                            id="images-csv-path" 
                            class="form-input"
                            placeholder="Cas/Cas4/images.csv"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="images-reset">
                            <span>R√©initialiser la collection d'images existante</span>
                            <span class="help-icon" data-tooltip="‚ö†Ô∏è Supprime toutes les images existantes avant le chargement">?</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        üì§ Charger et indexer les images
                    </button>
                </form>
            </div>

            <!-- Section: Configuration du syst√®me -->
            <div class="card">
                <div class="card-header">
                    ‚öôÔ∏è Configuration du moteur
                    <button type="button" id="btn-info-persistance" class="btn btn-sm btn-secondary" style="margin-left: auto;">
                        ‚ÑπÔ∏è Persistance
                    </button>
                </div>

                <form id="config-form">
                    <!-- ENCODAGE -->
                    <h3 style="color: var(--accent-color); margin-bottom: var(--spacing-md); font-size: 1.1rem;">
                        üß† Encodage
                    </h3>

                    <div class="form-group">
                        <label class="form-label">
                            Mod√®le d'embedding
                            <span class="help-icon" data-tooltip="Mod√®le Sentence Transformer utilis√© pour encoder les messages en vecteurs. Rechargement automatique sans red√©marrage.">?</span>
                        </label>
                        <select id="config-modele-embedding" class="form-select">
                            <option value="">Chargement...</option>
                        </select>
                        <small class="form-help" id="modele-description"></small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            P√©riph√©rique d'encodage
                            <span class="help-icon" data-tooltip="Mat√©riel utilis√© pour l'encodage. 'auto' d√©tecte CUDA si disponible. Rechargement automatique sans red√©marrage.">?</span>
                        </label>
                        <select id="config-peripherique" class="form-select">
                            <option value="auto">Auto (recommand√©)</option>
                            <option value="cpu">CPU</option>
                            <option value="cuda">CUDA (GPU)</option>
                        </select>
                    </div>

                    <div class="card-divider"></div>

                    <!-- CHUNKING -->
                    <h3 style="color: var(--accent-color); margin-bottom: var(--spacing-md); font-size: 1.1rem;">
                        ‚úÇÔ∏è Chunking (D√©coupage contextuel)
                    </h3>

                    <div class="form-group">
                        <label class="form-label">
                            Taille de la fen√™tre
                            <span class="help-icon" data-tooltip="Nombre de messages dans une fen√™tre de contexte. Red√©marrage requis.">?</span>
                        </label>
                        <input 
                            type="number" 
                            id="config-taille-fenetre" 
                            class="form-input"
                            min="1"
                            max="50"
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Chevauchement (overlap)
                            <span class="help-icon" data-tooltip="Nombre de messages en commun entre chunks successifs. Red√©marrage requis.">?</span>
                        </label>
                        <input 
                            type="number" 
                            id="config-overlap" 
                            class="form-input"
                            min="0"
                            max="25"
                        >
                    </div>

                    <div class="card-divider"></div>

                    <!-- RECHERCHE -->
                    <h3 style="color: var(--accent-color); margin-bottom: var(--spacing-md); font-size: 1.1rem;">
                        üîç Recherche
                    </h3>

                    <div class="form-group">
                        <label class="form-label">
                            M√©thode de recherche
                            <span class="help-icon" data-tooltip="ANN: rapide mais approximatif (~95-99% pr√©cision). KNN: exact mais plus lent.">?</span>
                        </label>
                        <select id="config-methode" class="form-select">
                            <option value="ANN">ANN (Approximate Nearest Neighbors)</option>
                            <option value="KNN">KNN (K-Nearest Neighbors - Exact)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Nombre de r√©sultats par d√©faut
                            <span class="help-icon" data-tooltip="Nombre de r√©sultats retourn√©s par la recherche (top K)">?</span>
                        </label>
                        <input 
                            type="number" 
                            id="config-nb-results" 
                            class="form-input"
                            min="1"
                            max="1000"
                            value="10"
                        >
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="config-exclure-bruit" checked>
                            <span>Exclure le bruit par d√©faut (spam/publicit√©s)</span>
                            <span class="help-icon" data-tooltip="Active le filtre anti-spam automatiquement lors des recherches">?</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Seuil de distance maximale
                            <span class="help-icon" data-tooltip="Distance cosine maximale accept√©e (vide = pas de limite). Plus la valeur est faible, plus les r√©sultats sont pertinents.">?</span>
                        </label>
                        <input 
                            type="number" 
                            id="config-seuil-distance" 
                            class="form-input"
                            step="0.01"
                            min="0"
                            max="2"
                            placeholder="Aucun seuil"
                        >
                        <small class="form-help">
                            Laissez vide pour aucun seuil. Valeurs typiques : 0.3-0.7
                        </small>
                    </div>

                    <h4 style="color: var(--text-white); margin-top: var(--spacing-xl); margin-bottom: var(--spacing-md); padding-top: var(--spacing-lg); border-top: 1px solid var(--border-color);">
                        üñºÔ∏è Param√®tres d'images
                    </h4>

                    <div class="form-group">
                        <label class="form-label">
                            Longueur minimale de description
                            <span class="help-icon" data-tooltip="Nombre minimum de tokens g√©n√©r√©s par BLIP pour la description">?</span>
                        </label>
                        <input 
                            type="number" 
                            id="config-img-min-length" 
                            class="form-input"
                            min="10"
                            max="100"
                            step="5"
                            value="30"
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Longueur maximale de description
                            <span class="help-icon" data-tooltip="Nombre maximum de tokens g√©n√©r√©s par BLIP pour la description">?</span>
                        </label>
                        <input 
                            type="number" 
                            id="config-img-max-length" 
                            class="form-input"
                            min="50"
                            max="300"
                            step="10"
                            value="150"
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Nombre de beams
                            <span class="help-icon" data-tooltip="Plus de beams = meilleure qualit√© mais plus lent (typique: 5-20)">?</span>
                        </label>
                        <input 
                            type="number" 
                            id="config-img-num-beams" 
                            class="form-input"
                            min="1"
                            max="50"
                            step="1"
                            value="15"
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Temp√©rature
                            <span class="help-icon" data-tooltip="Contr√¥le la cr√©ativit√© (0.0-1.0). Plus bas = plus d√©terministe">?</span>
                        </label>
                        <input 
                            type="number" 
                            id="config-img-temperature" 
                            class="form-input"
                            min="0"
                            max="1"
                            step="0.1"
                            value="0.3"
                        >
                    </div>

                    <button type="submit" class="btn btn-success">
                        üíæ Sauvegarder la configuration
                    </button>
                </form>
            </div>

            <!-- Section: Statistiques (collapsible) -->
            <div class="card">
                <div class="collapsible collapsed" id="stats-collapsible">
                    <div class="collapsible-header">
                        <span style="font-size: 1.125rem; font-weight: 600; color: var(--text-white);">
                            üìä Statistiques d'indexation
                        </span>
                        <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                            <button id="refresh-stats" class="btn btn-sm btn-secondary">
                                üîÑ Actualiser
                            </button>
                            <span class="collapsible-icon">‚ñº</span>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div id="stats-container">
                            <div class="flex-center" style="padding: 2rem;">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Info Persistance -->
    <div id="modal-persistance" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 4000; display: flex; align-items: center; justify-content: center;">
        <div style="background: var(--bg-card); border: 2px solid var(--accent-color); border-radius: var(--border-radius-lg); padding: var(--spacing-2xl); max-width: 600px; box-shadow: var(--shadow-glow);">
            <h3 style="color: var(--accent-color); margin-bottom: var(--spacing-md);">üíæ Persistance de la configuration</h3>
            <p style="margin-bottom: var(--spacing-md); line-height: 1.6;">
                Les modifications sont <strong>sauvegard√©es de mani√®re permanente</strong> dans le fichier <code>config/settings.json</code>.
            </p>
            <p style="margin-bottom: var(--spacing-md); line-height: 1.6;">
                ‚úÖ <strong>Mod√®le d'embedding & p√©riph√©rique:</strong> Rechargement <strong>automatique</strong> sans red√©marrage (peut prendre quelques secondes pour les gros mod√®les).
            </p>
            <p style="margin-bottom: var(--spacing-md); line-height: 1.6;">
                ‚ö†Ô∏è <strong>Chunking:</strong> Les changements de taille de fen√™tre ou overlap n√©cessitent un <strong>red√©marrage du serveur</strong> pour √™tre appliqu√©s.
            </p>
            <p style="line-height: 1.6;">
                ‚úÖ <strong>Param√®tres de recherche:</strong> Appliqu√©s imm√©diatement sans red√©marrage.
            </p>
            <button onclick="document.getElementById('modal-persistance').classList.add('hidden')" class="btn btn-primary" style="margin-top: var(--spacing-lg);">
                Compris
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/gestion.js"></script>
    <script>
        // Gestion du logo manquant
        const logo = document.querySelector('.header-logo-full');
        if (logo) {
            logo.onerror = function() {
                this.style.display = 'none';
                const headerBrand = document.querySelector('.header-brand');
                if (headerBrand) {
                    headerBrand.innerHTML = `
                        <div class="header-text">
                            <h1 class="app-title">OPSEMIA</h1>
                            <p class="app-subtitle">Configuration & Gestion des Donn√©es</p>
                        </div>
                    `;
                }
            };
        }
        
        // Gestion du collapsible
        document.getElementById('stats-collapsible')?.addEventListener('click', function(e) {
            if (e.target.closest('#refresh-stats')) return;
            this.classList.toggle('collapsed');
        });
        
        // Charger les stats au premier clic
        let statsLoaded = false;
        document.getElementById('stats-collapsible')?.addEventListener('click', function() {
            if (!statsLoaded && !this.classList.contains('collapsed')) {
                statsLoaded = true;
                if (typeof chargerStatistiques === 'function') {
                    chargerStatistiques();
                }
            }
        });

        // Modal persistance
        document.getElementById('btn-info-persistance')?.addEventListener('click', function() {
            document.getElementById('modal-persistance')?.classList.remove('hidden');
        });
    </script>
</body>
</html>
