graph TB
    subgraph INPUT["üì± DONN√âES BRUTES"]
        RAW["Support Num√©rique<br/>(E01, ZIP, Dossier)"]
    end

    subgraph EXTRACTION["üîß SERVICE EXTRACTION"]
        PARSER["Parser Forensique<br/>- E01 Reader<br/>- ZIP Extractor<br/>- Filesystem Walker"]
        STRUCT["Structuration<br/>- Messages<br/>- Emails<br/>- Images<br/>- Vid√©os"]
        PARSER --> STRUCT
    end

    subgraph CSV_STORAGE["üìä CSV STRUCTUR√âS"]
        CSV_MSG["messages.csv<br/>(id, timestamp, from, to,<br/>message, gps_lat, gps_lon)"]
        CSV_MAIL["emails.csv<br/>(id, timestamp, from, to,<br/>subject, body)"]
        CSV_IMG["images.csv<br/>(id, timestamp, filepath,<br/>gps_lat, gps_lon)"]
        CSV_VID["videos.csv<br/>(id, timestamp, filepath,<br/>gps_lat, gps_lon)"]
    end

    subgraph DENOISING["üö´ SERVICE D√âBRUITAGE"]
        SPAM_DETECT["D√©tecteur Pubs/Spam<br/>- R√®gles heuristiques<br/>- Patterns commerciaux<br/>- Liste annonceurs"]
        FLAG["Ajout colonne<br/>'is_noise' (bool)"]
        SPAM_DETECT --> FLAG
    end

    subgraph CONFIG["‚öôÔ∏è CONFIGURATION"]
        SETTINGS["settings.py<br/>---<br/>‚Ä¢ EMBEDDING_MODEL<br/>‚Ä¢ VISION_MODEL<br/>‚Ä¢ SYSTEM_PROMPT<br/>‚Ä¢ CHUNK_SIZE<br/>‚Ä¢ CHUNK_OVERLAP<br/>‚Ä¢ SEARCH_METHOD (ANN/KNN)<br/>‚Ä¢ ANN_INDEX_TYPE<br/>‚Ä¢ DIMENSIONS"]
    end

    subgraph ENCODING["üß† SERVICE ENCODAGE"]
        MODEL_MGR["Model Manager<br/>(dynamique)"]
        
        subgraph TEXT_ENC["Encodage Texte"]
            BGE["BGE-M3<br/>(param√©trable)<br/>768/1024 dims"]
            CHUNKS["Chunking<br/>- Messages individuels<br/>- Fen√™tre glissante<br/>(N messages)"]
        end
        
        subgraph IMG_ENC["Encodage Images"]
            BLIP["BLIP-base<br/>Description ‚Üí Texte"]
            IMG_TO_TXT["Text ‚Üí BGE-M3"]
        end
        
        MODEL_MGR --> BGE
        MODEL_MGR --> BLIP
    end

    subgraph FINE_TUNE["üéØ FINE-TUNING (Optionnel)"]
        FT_DATA["Donn√©es Labellis√©es<br/>- Conversations suspectes<br/>- Paires (query, doc)<br/>- Scores de pertinence"]
        FT_TRAIN["Training<br/>- Contrastive Loss<br/>- LoRA (efficace)<br/>- 1-3 epochs"]
        FT_MODEL["Mod√®le Adapt√©<br/>Jargon criminel FR"]
        FT_DATA --> FT_TRAIN --> FT_MODEL
    end

    subgraph VECTOR_DB["üíæ BASE VECTORIELLE"]
        CHROMA["ChromaDB<br/>(SQLite backend)<br/>chroma.sqlite3"]
        
        subgraph COLLECTIONS["Collections"]
            COL_MSG["messages<br/>- embeddings<br/>- metadata<br/>- is_noise flag"]
            COL_CHUNK["message_chunks<br/>- context embeddings<br/>- chunk_ids"]
            COL_IMG["images<br/>- description embeddings<br/>- filepath"]
            COL_MAIL["emails<br/>- embeddings<br/>- metadata"]
        end
        
        CHROMA --> COL_MSG
        CHROMA --> COL_CHUNK
        CHROMA --> COL_IMG
        CHROMA --> COL_MAIL
    end

    subgraph SEARCH["üîç SERVICE RECHERCHE"]
        QUERY_INPUT["Requ√™te Utilisateur<br/>+ Filtres"]
        QUERY_ENC["Encodage Requ√™te<br/>(m√™me mod√®le)"]
        
        FILTERS["Filtres Pr√©-Recherche<br/>- Timestamp (d√©but/fin)<br/>- GPS (rayon)<br/>- Type (msg/mail/img)<br/>- Exclude noise<br/>‚Üí R√©duit corpus"]
        
        subgraph SEARCH_ENGINE["Moteur de Recherche<br/>(sur corpus filtr√©)"]
            ANN_SEARCH["ANN Search<br/>(HNSW, IVF)<br/>- Rapide<br/>- ~95% pr√©cision"]
            KNN_SEARCH["KNN Search<br/>(Brute Force)<br/>- Exact<br/>- Plus lent"]
        end
        
        RANKING["Post-Ranking<br/>- Cosine similarity<br/>- Score boost (mots-cl√©s)<br/>- R√©ordonnancement"]
        
        QUERY_INPUT --> QUERY_ENC
        QUERY_INPUT --> FILTERS
        FILTERS --> ANN_SEARCH
        FILTERS --> KNN_SEARCH
        ANN_SEARCH --> RANKING
        KNN_SEARCH --> RANKING
        QUERY_ENC --> ANN_SEARCH
        QUERY_ENC --> KNN_SEARCH
    end

    subgraph RESULTS["üìã R√âSULTATS"]
        TOP_K["Top K r√©sultats<br/>(score, contenu, metadata)"]
        CONTEXT["Vue Contextuelle<br/>- Messages adjacents<br/>- Timeline<br/>- Carte g√©ospatiale"]
    end

    subgraph UI["üñ•Ô∏è INTERFACE WEB"]
        SEARCH_UI["Barre de Recherche<br/>+ Filtres avanc√©s"]
        VIZ["Visualisations<br/>- Liste r√©sultats<br/>- Timeline<br/>- Carte<br/>- Graphe relations"]
        ADMIN["Admin<br/>- Charger dossier<br/>- Config mod√®le<br/>- Fine-tuning<br/>- Stats indexation"]
    end

    %% Flux principal
    RAW --> PARSER
    STRUCT --> CSV_MSG
    STRUCT --> CSV_MAIL
    STRUCT --> CSV_IMG
    STRUCT --> CSV_VID
    
    CSV_MSG --> SPAM_DETECT
    CSV_MAIL --> SPAM_DETECT
    
    FLAG --> BGE
    FLAG --> CHUNKS
    CHUNKS --> BGE
    CSV_IMG --> BLIP
    BLIP --> IMG_TO_TXT
    IMG_TO_TXT --> BGE
    
    BGE --> CHROMA
    
    CONFIG -.-> MODEL_MGR
    CONFIG -.-> SEARCH_ENGINE
    FT_MODEL -.-> MODEL_MGR
    
    RANKING --> TOP_K
    TOP_K --> VIZ
    
    SEARCH_UI --> QUERY_INPUT
    VIZ --> CONTEXT
    ADMIN --> CONFIG
    ADMIN --> FT_TRAIN
    
    %% Styles
    classDef inputStyle fill:#e1f5ff,stroke:#0288d1,stroke-width:2px
    classDef processStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef storageStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef searchStyle fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef uiStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef configStyle fill:#fff9c4,stroke:#f9a825,stroke-width:2px
    
    class RAW,CSV_MSG,CSV_MAIL,CSV_IMG,CSV_VID inputStyle
    class PARSER,STRUCT,SPAM_DETECT,FLAG,BGE,BLIP,CHUNKS,IMG_TO_TXT,MODEL_MGR processStyle
    class CHROMA,COL_MSG,COL_CHUNK,COL_IMG,COL_MAIL storageStyle
    class QUERY_INPUT,QUERY_ENC,ANN_SEARCH,KNN_SEARCH,FILTERS,RANKING searchStyle
    class SEARCH_UI,VIZ,ADMIN,TOP_K,CONTEXT uiStyle
    class CONFIG,SETTINGS,FT_DATA,FT_TRAIN,FT_MODEL configStyle